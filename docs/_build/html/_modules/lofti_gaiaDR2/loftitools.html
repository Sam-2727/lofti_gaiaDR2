

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lofti_gaiaDR2.loftitools &mdash; lofti_gaiaDR2 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> lofti_gaiaDR2
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Detailed API Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">lofti_gaiaDR2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>lofti_gaiaDR2.loftitools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lofti_gaiaDR2.loftitools</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">tan</span><span class="p">,</span> <span class="n">arctan</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">arccos</span>

<div class="viewcode-block" id="MonteCarloIt"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.MonteCarloIt">[docs]</a><span class="k">def</span> <span class="nf">MonteCarloIt</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    Generate a random sample of size = N from a </span>
<span class="sd">    Gaussian centered at thing[0] with std thing[1]</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        thing (tuple, flt): tuple of (value,uncertainty).  Can be either astropy units object \</span>
<span class="sd">            or float</span>
<span class="sd">        N (int): number of samples</span>
<span class="sd">    Returns:</span>
<span class="sd">        array: N random samples from a Gaussian.</span>

<span class="sd">    Written by Logan Pearce, 2020</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">thing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">thing</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">thing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">thing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">N</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="distance"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.distance">[docs]</a><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">parallax</span><span class="p">,</span><span class="n">parallax_error</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes distance from Gaia parallaxes using the Bayesian method of Bailer-Jones 2015.</span>

<span class="sd">    Args:</span>
<span class="sd">        parallax, parallax error (flt): parallax in mas</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple, flt:</span>
<span class="sd">            distance (flt): distance to systems in pc</span>

<span class="sd">            sigma (flt): 1-sigma uncertainty in distance</span>

<span class="sd">    Written by Logan Pearce, 2018</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Compute most probable distance:</span>
    <span class="n">L</span><span class="o">=</span><span class="mi">1350</span> <span class="c1">#parsecs</span>
    <span class="c1"># Convert to arcsec:</span>
    <span class="n">parallax</span><span class="p">,</span> <span class="n">parallax_error</span> <span class="o">=</span> <span class="n">parallax</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span> <span class="n">parallax_error</span><span class="o">/</span><span class="mf">1000.</span>
    <span class="c1"># establish the coefficients of the mode-finding polynomial:</span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">1.</span><span class="o">/</span><span class="n">L</span><span class="p">),(</span><span class="o">-</span><span class="mi">2</span><span class="p">),((</span><span class="n">parallax</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">parallax_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="o">-</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">((</span><span class="n">parallax_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))])</span>
    <span class="c1"># use numpy to find the roots:</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
    <span class="c1"># Find the number of real roots:</span>
    <span class="n">reals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">realsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reals</span><span class="p">)</span>
    <span class="c1"># If there is one real root, that root is the  mode:</span>
    <span class="k">if</span> <span class="n">realsum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">gd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">reals</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="c1"># If all roots are real:</span>
    <span class="k">elif</span> <span class="n">realsum</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parallax</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Take the smallest root:</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">parallax</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Take the positive root (there should be only one):</span>
            <span class="n">gd</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">g</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    
    <span class="c1"># Compute error on distance from FWHM of probability distribution:</span>
    <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">brentq</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="mf">1e6</span>
    <span class="n">rmode</span> <span class="o">=</span> <span class="n">gd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmode</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">rmode</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">/</span><span class="n">parallax_error</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">parallax_error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">parallax</span><span class="o">-</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">rmode</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">-</span><span class="p">(((</span><span class="n">parallax</span><span class="o">-</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">x</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parallax_error</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> \
               <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">parallax_error</span><span class="p">),</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">rmode</span><span class="p">)</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">L</span><span class="p">)</span><span class="o">-</span><span class="p">(((</span><span class="n">parallax</span><span class="o">-</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">x</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">parallax_error</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> \
               <span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">M</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">parallax_error</span><span class="p">),</span> <span class="n">rmode</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span>
    <span class="n">fwhm</span> <span class="o">=</span> <span class="n">hi</span><span class="o">-</span><span class="n">lo</span>
    <span class="c1"># Compute 1-sigma from FWHM:</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm</span><span class="o">/</span><span class="mf">2.355</span>
            
    <span class="k">return</span> <span class="n">gd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sigma</span></div>

<div class="viewcode-block" id="masyr_to_kms"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.masyr_to_kms">[docs]</a><span class="k">def</span> <span class="nf">masyr_to_kms</span><span class="p">(</span><span class="n">mas_yr</span><span class="p">,</span><span class="n">plx</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert from mas/yr -&gt; km/s</span>
<span class="sd">     </span>
<span class="sd">    Args:</span>
<span class="sd">        mas_yr (array): velocity in mas/yr</span>
<span class="sd">        plx (tuple,float): parallax, tuple of (plx,plx error)</span>
<span class="sd">    Returns:</span>
<span class="sd">        array : velocity in km/s</span>
<span class="sd">    </span>
<span class="sd">    Written by Logan Pearce, 2019</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="o">*</span><span class="n">plx</span><span class="p">)</span>
    <span class="c1"># convert mas to km:</span>
    <span class="n">km_s</span> <span class="o">=</span> <span class="p">[((</span><span class="n">mas_yr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="p">,</span> <span class="p">((</span><span class="n">mas_yr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)]</span>
    <span class="c1"># convert yr to s:</span>
    <span class="n">km_s</span> <span class="o">=</span> <span class="p">[(</span><span class="n">km_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="n">km_s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)]</span>
    
    <span class="k">return</span> <span class="n">km_s</span></div>

<div class="viewcode-block" id="mas_to_km"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.mas_to_km">[docs]</a><span class="k">def</span> <span class="nf">mas_to_km</span><span class="p">(</span><span class="n">mas</span><span class="p">,</span><span class="n">plx</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert from mas -&gt; km</span>

<span class="sd">    Args:</span>
<span class="sd">        mas (array, flt): sep in mas</span>
<span class="sd">        plx (tuple, flt): parallax, tuple of (plx,plx error) in mas</span>
<span class="sd">    Returns:</span>
<span class="sd">        array : separation in km</span>

<span class="sd">    Written by Logan Pearce, 2019</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="o">*</span><span class="n">plx</span><span class="p">)</span>
    <span class="c1"># convert mas to km:</span>
    <span class="n">km</span> <span class="o">=</span> <span class="p">[((</span><span class="n">mas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="p">,</span> <span class="p">((</span><span class="n">mas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">km</span></div>

<div class="viewcode-block" id="mas_to_km2"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.mas_to_km2">[docs]</a><span class="k">def</span> <span class="nf">mas_to_km2</span><span class="p">(</span><span class="n">arcsec</span><span class="p">,</span><span class="n">dist</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert from mas -&gt; km using the distance rather than parallax.  Does not</span>
<span class="sd">    compute errors on separation.</span>

<span class="sd">    Args:</span>
<span class="sd">        arcsec (array, flt): sep in arcsec</span>
<span class="sd">        dist (array, flt): distance in parsecs</span>
<span class="sd">    Returns:</span>
<span class="sd">        array : separation in km</span>

<span class="sd">    Written by Logan Pearce, 2019</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># convert to arcsec, and multiply by distance in pc:</span>
    <span class="n">km</span> <span class="o">=</span> <span class="p">(</span><span class="n">arcsec</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span> <span class="c1"># AU</span>
    <span class="n">km</span> <span class="o">=</span> <span class="n">km</span> <span class="o">*</span> <span class="mi">149598073</span> <span class="c1"># km/AU</span>

    <span class="k">return</span> <span class="n">km</span></div>

<div class="viewcode-block" id="to_polar"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.to_polar">[docs]</a><span class="k">def</span> <span class="nf">to_polar</span><span class="p">(</span><span class="n">RAa</span><span class="p">,</span><span class="n">RAb</span><span class="p">,</span><span class="n">Deca</span><span class="p">,</span><span class="n">Decb</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Converts RA/Dec [deg] of two binary components into separation and position angle of B relative </span>
<span class="sd">        to A [mas, deg]</span>

<span class="sd">    Args:</span>
<span class="sd">        RAa, RAb, Deca, Decb (flt): RA/Dec of each object in deg</span>
<span class="sd">    Returns:</span>
<span class="sd">        tuple, flt: separation in mas and position angle in degrees from North</span>

<span class="sd">    Written by Logan Pearce, 2019</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">dRA</span> <span class="o">=</span> <span class="p">(</span><span class="n">RAb</span> <span class="o">-</span> <span class="n">RAa</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">Deca</span><span class="p">,</span><span class="n">Decb</span><span class="p">])))</span>
    <span class="n">dRA</span> <span class="o">=</span> <span class="p">(</span><span class="n">dRA</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span>
    <span class="n">dDec</span> <span class="o">=</span> <span class="p">(</span><span class="n">Decb</span> <span class="o">-</span> <span class="n">Deca</span><span class="p">)</span>
    <span class="n">dDec</span> <span class="o">=</span> <span class="p">(</span><span class="n">dDec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">dRA</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dDec</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">dDec</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="o">-</span><span class="n">dRA</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="mf">270.</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span>
    
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span></div>

<div class="viewcode-block" id="add_in_quad"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.add_in_quad">[docs]</a><span class="k">def</span> <span class="nf">add_in_quad</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add elements of an array of things in quadrature</span>

<span class="sd">    Args:</span>
<span class="sd">        thing (arr, flt): array of things to add in quadrature</span>
<span class="sd">    Returns:</span>
<span class="sd">        flt : single value of things added in quadrature</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="ComputeChi2"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.ComputeChi2">[docs]</a><span class="k">def</span> <span class="nf">ComputeChi2</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Cumpute the Chi2 for an array of model predictions and measurements</span>

<span class="sd">    Args:</span>
<span class="sd">        array (2 x N array): array of observations, row [0] = value, row [1] = errors</span>
<span class="sd">        model (1 x N array): array of model predicitons</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        flt : Chi^2 value</span>

<span class="sd">    Written by Logan Pearce, 2020</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)):</span>
        <span class="n">chi</span> <span class="o">+=</span> <span class="p">(</span> <span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">model</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">chi</span></div>

<span class="c1">######## Fitting tools: ##############</span>
<div class="viewcode-block" id="eccentricity_anomaly"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.eccentricity_anomaly">[docs]</a><span class="k">def</span> <span class="nf">eccentricity_anomaly</span><span class="p">(</span><span class="n">E</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">M</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Eccentric anomaly function&#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">return</span> <span class="n">E</span> <span class="o">-</span> <span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">))</span> <span class="o">-</span> <span class="n">M</span></div>

<div class="viewcode-block" id="solve"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.solve">[docs]</a><span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">M0</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">maxnum</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Newton-Raphson solver for eccentricity anomaly</span>
<span class="sd">    from https://stackoverflow.com/questions/20659456/python-implementing-a-numerical-equation-solver-newton-raphson</span>

<span class="sd">    Args: </span>
<span class="sd">        f (function): function to solve (transcendental ecc. anomaly function)</span>
<span class="sd">        M0 (float): mean anomaly</span>
<span class="sd">        e (float): eccentricity</span>
<span class="sd">        h (float): termination criteria for solver</span>
<span class="sd">    Returns: </span>
<span class="sd">        flt : converged solution for eccentric anomaly</span>

<span class="sd">    Written by Logan Pearce, 2017</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    
    <span class="k">if</span> <span class="n">M0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="mf">6.</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="p">))</span> <span class="o">/</span> <span class="n">e</span> <span class="p">)</span> <span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">E0</span> <span class="o">=</span> <span class="n">M0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">E0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">6.</span> <span class="o">*</span> <span class="n">M0</span> <span class="o">/</span> <span class="n">e</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
    <span class="n">lastE</span> <span class="o">=</span> <span class="n">E0</span>
    <span class="n">nextE</span> <span class="o">=</span> <span class="n">lastE</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span> <span class="n">h</span>  
    <span class="n">number</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lastE</span> <span class="o">-</span> <span class="n">nextE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">)</span> <span class="ow">and</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">1001</span><span class="p">:</span>  
        <span class="n">newY</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">nextE</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">M0</span><span class="p">)</span> 
        <span class="n">lastE</span> <span class="o">=</span> <span class="n">nextE</span>
        <span class="n">nextE</span> <span class="o">=</span> <span class="n">lastE</span> <span class="o">-</span> <span class="n">newY</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lastE</span><span class="p">))</span>
        <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="n">maxnum</span><span class="p">:</span>
            <span class="n">nextE</span> <span class="o">=</span> <span class="n">mikkola_solve</span><span class="p">(</span><span class="n">M0</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nextE</span></div>

<div class="viewcode-block" id="danby_solve"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.danby_solve">[docs]</a><span class="k">def</span> <span class="nf">danby_solve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">M0</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">maxnum</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Newton-Raphson solver for eccentricity anomaly based on &quot;Danby&quot; method.</span>

<span class="sd">    Args: </span>
<span class="sd">        f (function): function to solve (transcendental ecc. anomaly function)</span>
<span class="sd">        M0 (float): mean anomaly</span>
<span class="sd">        e (float): eccentricity</span>
<span class="sd">        h (float): termination criteria for solver</span>
<span class="sd">        maxnum (int): if it takes more than maxnum iterations, \</span>
<span class="sd">            use the Mikkola solver instead.</span>
<span class="sd">    Returns: </span>
<span class="sd">        flt : converged solution for eccentric anomaly</span>

<span class="sd">    Written by Logan Pearce, 2019</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#f = eccentricity_anomaly</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mf">0.85</span>
    <span class="n">E0</span> <span class="o">=</span> <span class="n">M0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">M0</span><span class="p">))</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">e</span>
    <span class="n">lastE</span> <span class="o">=</span> <span class="n">E0</span>
    <span class="n">nextE</span> <span class="o">=</span> <span class="n">lastE</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span> <span class="n">h</span> 
    <span class="n">number</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">delta_D</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">delta_D</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">)</span> <span class="ow">and</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="n">maxnum</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">fx</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">nextE</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">M0</span><span class="p">)</span> 
        <span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lastE</span><span class="p">))</span> 
        <span class="n">fpp</span> <span class="o">=</span> <span class="n">e</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lastE</span><span class="p">)</span>
        <span class="n">fppp</span> <span class="o">=</span> <span class="n">e</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lastE</span><span class="p">)</span>
        <span class="n">lastE</span> <span class="o">=</span> <span class="n">nextE</span>
        <span class="n">delta_N</span> <span class="o">=</span> <span class="o">-</span><span class="n">fx</span> <span class="o">/</span> <span class="n">fp</span>
        <span class="n">delta_H</span> <span class="o">=</span> <span class="o">-</span><span class="n">fx</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">fpp</span><span class="o">*</span><span class="n">delta_N</span><span class="p">)</span>
        <span class="n">delta_D</span> <span class="o">=</span> <span class="o">-</span><span class="n">fx</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">fpp</span><span class="o">*</span><span class="n">delta_H</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">fppp</span><span class="o">*</span><span class="n">delta_H</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">nextE</span> <span class="o">=</span> <span class="n">lastE</span> <span class="o">+</span> <span class="n">delta_D</span>
        <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="n">maxnum</span><span class="p">:</span>
            <span class="n">nextE</span> <span class="o">=</span> <span class="n">mikkola_solve</span><span class="p">(</span><span class="n">M0</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nextE</span></div>


<div class="viewcode-block" id="mikkola_solve"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.mikkola_solve">[docs]</a><span class="k">def</span> <span class="nf">mikkola_solve</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Analytic solver for eccentricity anomaly from Mikkola 1987. Most efficient</span>
<span class="sd">    when M near 0/2pi and e &gt;= 0.95.</span>

<span class="sd">    Args: </span>
<span class="sd">        M (float): mean anomaly</span>
<span class="sd">        e (float): eccentricity</span>
<span class="sd">    Returns: </span>
<span class="sd">        flt: eccentric anomaly</span>

<span class="sd">    Written by Logan Pearce, 2019</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Constants:</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mf">4.</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">M</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mf">4.</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mf">3.</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">beta</span> <span class="o">+</span> <span class="n">ab</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>

    <span class="c1"># Compute s:</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">/</span><span class="n">z</span>
    <span class="c1"># Compute correction on s:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.078</span> <span class="o">*</span> <span class="p">(</span><span class="n">s1</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">+</span> <span class="n">ds</span>

    <span class="c1"># Compute E:</span>
    <span class="n">E0</span> <span class="o">=</span> <span class="n">M</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="p">(</span> <span class="mf">3.</span><span class="o">*</span><span class="n">s</span> <span class="o">-</span> <span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mf">3.</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># Compute final correction to E:</span>
    <span class="n">sinE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">E0</span><span class="p">)</span>
    <span class="n">cosE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">E0</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">E0</span> <span class="o">-</span> <span class="n">e</span><span class="o">*</span><span class="n">sinE</span> <span class="o">-</span> <span class="n">M</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">e</span><span class="o">*</span><span class="n">cosE</span>
    <span class="n">fpp</span> <span class="o">=</span> <span class="n">e</span><span class="o">*</span><span class="n">sinE</span>
    <span class="n">fppp</span> <span class="o">=</span> <span class="n">e</span><span class="o">*</span><span class="n">cosE</span>
    <span class="n">fpppp</span> <span class="o">=</span> <span class="o">-</span><span class="n">fpp</span>

    <span class="n">dx1</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span> <span class="n">fp</span>
    <span class="n">dx2</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="n">fp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">fpp</span><span class="o">*</span><span class="n">dx1</span><span class="p">)</span>
    <span class="n">dx3</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span> <span class="n">fp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">fpp</span><span class="o">*</span><span class="n">dx2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="n">fppp</span><span class="o">*</span><span class="p">(</span><span class="n">dx2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">dx4</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span> <span class="n">fp</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">fpp</span><span class="o">*</span><span class="n">dx3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="n">fppp</span><span class="o">*</span><span class="p">(</span><span class="n">dx3</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">24.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">fpppp</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dx3</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">E0</span> <span class="o">+</span> <span class="n">dx4</span></div>

<div class="viewcode-block" id="draw_samples"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.draw_samples">[docs]</a><span class="k">def</span> <span class="nf">draw_samples</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">m_tot</span><span class="p">,</span> <span class="n">d_star</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Draw a set of orbital elements from proability distribution functions.</span>

<span class="sd">    Parameters are drawn from the probability distributions:</span>

<span class="sd">        -a: single value for semi-major axis due to scale and rotate</span>

<span class="sd">        -const: unif [0,1]</span>

<span class="sd">        -e: unif [0,1)</span>

<span class="sd">        -cos(i): unif [0,1]</span>

<span class="sd">        -w: unif [0,360] deg</span>

<span class="sd">        -O: single value fixed at 0 due to scale and rotate</span>

<span class="sd">    Args: </span>
<span class="sd">        number (int): number of orbits desired to draw elements for. Typically 10000</span>
<span class="sd">        m_tot (tuple, flt): total system mass[0] and error[1] in solar masses</span>
<span class="sd">        d_star (tuple, flt): distance to system in pc</span>
<span class="sd">        date (flt): observation date.  2015.5 for Gaia DR2</span>

<span class="sd">    Returns:</span>
<span class="sd">        array:</span>
<span class="sd">            a (flt): semi-major axis, as</span>

<span class="sd">            T (flt): period, yrs</span>

<span class="sd">            to (flt): epoch of periastron passage (in same time structure as dates), yrs</span>

<span class="sd">            e (flt): eccentricity</span>

<span class="sd">            i (flt): inclination, rad</span>

<span class="sd">            w (flt): argument of periastron, rad</span>

<span class="sd">            O (flt): longitude of nodes, rad</span>

<span class="sd">            m1 (flt): system mass, Msun</span>

<span class="sd">            dist (flt): distance to system</span>
<span class="sd">    </span>
<span class="sd">    Written by Logan Pearce, 2018</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">m_tot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">m_tot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">number</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">d_star</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">d_star</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">number</span><span class="p">)</span>
    <span class="c1">#m1 = m_tot[0]</span>
    <span class="c1">#dist = d_star[0]</span>
    <span class="c1"># Fixing and initial semi-major axis:</span>
    <span class="n">a_au</span><span class="o">=</span><span class="mf">100.0</span>
    <span class="n">a_au</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a_au</span><span class="p">,</span><span class="n">a_au</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">a_au</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a_au</span><span class="o">/</span><span class="n">dist</span> <span class="c1">#semimajor axis in arcsec</span>

    <span class="c1"># Fixing an initial Longitude of ascending node in radians:</span>
    <span class="n">O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  
    <span class="n">O</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">O</span><span class="p">]</span><span class="o">*</span><span class="n">number</span><span class="p">)</span>

    <span class="c1"># Randomly generated parameters:</span>
    <span class="c1">#to = Time of periastron passage in years:</span>
    <span class="n">const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>
    <span class="c1">#^ Constant that represents the ratio between (reference epoch minus to) over period.  Because we are scaling</span>
    <span class="c1">#semi-major axis, period will also scale, and epoch of periastron passage will change as a result.  This ratio</span>
    <span class="c1">#will remain constant however, so we can use it scale both T and to appropriately.</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">date</span><span class="o">-</span><span class="p">(</span><span class="n">const</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Eccentricity:</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>
    <span class="c1"># Inclination in radians:</span>
    <span class="n">cosi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>  <span class="c1">#Draws sin(i) from a uniform distribution.  Inclination</span>
    <span class="c1"># is computed as the arccos of cos(i):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">cosi</span><span class="p">)</span>
    <span class="c1"># Argument of periastron in degrees:</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">360.0</span><span class="p">,</span><span class="n">number</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> 
    <span class="c1"># collect into array</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">10000</span><span class="p">))</span>
    <span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">3</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">4</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">5</span><span class="p">,:],</span> \
        <span class="n">samples</span><span class="p">[</span><span class="mi">6</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">7</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">8</span><span class="p">,:],</span><span class="n">samples</span><span class="p">[</span><span class="mi">9</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">dist</span>
    <span class="c1">#samples = np.array([a,T,const,to,e,i,w,O,m1,dist])</span>
    <span class="k">return</span> <span class="n">samples</span></div>

<div class="viewcode-block" id="scale_and_rotate"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.scale_and_rotate">[docs]</a><span class="k">def</span> <span class="nf">scale_and_rotate</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">rho</span><span class="p">,</span><span class="n">pa</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    Generates a new semi-major axis, period, epoch of peri passage, and long of peri for each orbit</span>
<span class="sd">    given the X,Y plane of the sky coordinates for the orbit at the date of the reference epoch.</span>
<span class="sd">    Called by calc_OFTI</span>

<span class="sd">    Args:</span>
<span class="sd">        X,Y (1 x N array): X and Y model predicted DEC/RA initial position in mas</span>
<span class="sd">        rho (tuple, flt): observed separation and error in mas</span>
<span class="sd">        pa (tuple, flt): observed position angle and error in deg</span>
<span class="sd">        a (1 x N array): initial semi-major axis </span>
<span class="sd">        const (1 x N array): initial orbit fraction</span>
<span class="sd">        m1: system mass</span>
<span class="sd">        dist: distance to system</span>
<span class="sd">        d: observation date (2015.5 for Gaia DR2)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        (4 x N array):</span>
<span class="sd">            a2 (1 x N array): scaled semi-major axis</span>

<span class="sd">            T2 (1 x N array): scaled period</span>

<span class="sd">            to2 (1 x N array): scaled periastron passage</span>

<span class="sd">            O2 (1 x N array): rotated lon of ascending node</span>

<span class="sd">    Written by Logan Pearce, 2018</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    
    <span class="n">r_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">rho_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">rho</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1000.</span><span class="p">,</span><span class="n">rho</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span> <span class="c1">#This generates a gaussian random to </span>
    <span class="c1">#scale to that takes observational uncertainty into account.  #convert to arcsec</span>
    <span class="c1">#rho_rand = rho/1000.</span>

    <span class="c1"># scale:</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">rho_rand</span><span class="o">/</span><span class="n">r_model</span><span class="p">)</span> 
    <span class="c1">#New period:</span>
    <span class="n">a2_au</span><span class="o">=</span><span class="n">a2</span><span class="o">*</span><span class="n">dist</span> <span class="c1">#convert to AU for period calc:</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">a2_au</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>
    <span class="c1">#New epoch of periastron passage</span>
    <span class="n">to2</span> <span class="o">=</span> <span class="n">d</span><span class="o">-</span><span class="p">(</span><span class="n">const</span><span class="o">*</span><span class="n">T2</span><span class="p">)</span>

    <span class="c1"># Rotate:</span>
    <span class="n">PA_model</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="o">-</span><span class="n">Y</span><span class="p">))</span><span class="o">+</span><span class="mi">270</span><span class="p">)</span><span class="o">%</span><span class="mi">360</span> <span class="c1">#corrects for difference in zero-point</span>
    <span class="c1">#between arctan function and ra/dec projection</span>
    <span class="n">PA_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">pa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pa</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#Generates a random PA within 1 sigma of observation</span>
    <span class="c1">#PA_rand = pa</span>
    <span class="c1">#New omega value:</span>
    <span class="n">O2</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">PA_i</span> <span class="ow">in</span> <span class="n">PA_model</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PA_i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">O2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">PA_rand</span><span class="o">-</span><span class="n">PA_i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">360.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">O2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PA_rand</span><span class="o">-</span><span class="n">PA_i</span><span class="p">)</span>
    <span class="c1"># ^ This step corrects for the fact that the arctan gives the angle from the +x axis being zero,</span>
    <span class="c1">#while for RA/Dec the zero angle is +y axis.  </span>

    <span class="c1">#Recompute model with new rotation:</span>
    <span class="n">O2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">O2</span><span class="p">)</span>
    <span class="n">O2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">O2</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">a2</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span><span class="n">to2</span><span class="p">,</span><span class="n">O2</span></div>

<div class="viewcode-block" id="calc_XYZ"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.calc_XYZ">[docs]</a><span class="k">def</span> <span class="nf">calc_XYZ</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Compute projected on-sky position only of a single object on a Keplerian orbit given a </span>
<span class="sd">    set of orbital elements at a single observation point. </span>
<span class="sd">    Called by calc_OFTI</span>

<span class="sd">    Args:</span>
<span class="sd">        a (flt): semi-major axis, as</span>
<span class="sd">        T (flt): period, yrs</span>
<span class="sd">        to (flt): epoch of periastron passage (in same time structure as dates), yrs</span>
<span class="sd">        e (flt): eccentricity</span>
<span class="sd">        i (flt): inclination, rad</span>
<span class="sd">        w (flt): argument of periastron, rad</span>
<span class="sd">        O (flt): longitude of nodes, rad</span>
<span class="sd">        m1 (flt): system mass, Msun</span>
<span class="sd">        date (flt): observation date, yrs</span>

<span class="sd">    Return: </span>
<span class="sd">        3-tuple:</span>
<span class="sd">            X, Y, Z: 3d positions in mas</span>

<span class="sd">    Written by Logan Pearce, 2018</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">T</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">date</span><span class="o">-</span><span class="n">to</span><span class="p">)</span>
    <span class="n">nextE</span> <span class="o">=</span> <span class="p">[</span><span class="n">danby_solve</span><span class="p">(</span><span class="n">eccentricity_anomaly</span><span class="p">,</span> <span class="n">varM</span><span class="p">,</span><span class="n">vare</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span> <span class="k">for</span> <span class="n">varM</span><span class="p">,</span><span class="n">vare</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">e</span><span class="p">)]</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nextE</span><span class="p">)</span>
    <span class="c1"># true anomaly:</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">)</span>
    <span class="c1"># orbit plane radius in as:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span> <span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span> <span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">E</span></div>

<div class="viewcode-block" id="calc_velocities"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.calc_velocities">[docs]</a><span class="k">def</span> <span class="nf">calc_velocities</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">E</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Compute 3-d velocity of a single object on a Keplerian orbit given a </span>
<span class="sd">    set of orbital elements at a single observation point.  Uses my eqns derived from Seager </span>
<span class="sd">    Exoplanets Ch2.</span>

<span class="sd">    Args:</span>
<span class="sd">        a (flt): semi-major axis, as</span>
<span class="sd">        T (flt): period, yrs</span>
<span class="sd">        to (flt): epoch of periastron passage (in same time structure as dates), yrs</span>
<span class="sd">        e (flt): eccentricity</span>
<span class="sd">        i (flt): inclination, rad</span>
<span class="sd">        w (flt): argument of periastron, rad</span>
<span class="sd">        O (flt): longitude of nodes, rad</span>
<span class="sd">        m1 (flt): system mass, Msun</span>
<span class="sd">        dist (flt): distance to system in pc, pc</span>
<span class="sd">        date (flt): observation date, yrs</span>
<span class="sd">        E (flt): eccentricity anomaly, computed in `calc_XYZ`</span>

<span class="sd">    Return: </span>
<span class="sd">        3-tuple:</span>
<span class="sd">            X dot, Y dot, Z dot: 3d velocities in km/s</span>

<span class="sd">    Written by Logan Pearce, 2018</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># convert to km:</span>
    <span class="n">a_km</span> <span class="o">=</span> <span class="n">mas_to_km2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span>
    
    <span class="c1"># Compute true anomaly:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">T</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">)</span>
    
    <span class="c1"># Compute velocities:</span>
    <span class="n">rdot</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">a_km</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="n">e</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">rfdot</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">a_km</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">Xdot</span> <span class="o">=</span> <span class="n">rdot</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">+</span> \
           <span class="n">rfdot</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">Ydot</span> <span class="o">=</span> <span class="n">rdot</span> <span class="o">*</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">+</span> \
           <span class="n">rfdot</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">Zdot</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span><span class="o">*</span><span class="n">a_km</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    
    <span class="n">Xdot</span> <span class="o">=</span> <span class="n">Xdot</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
    <span class="n">Ydot</span> <span class="o">=</span> <span class="n">Ydot</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
    <span class="n">Zdot</span> <span class="o">=</span> <span class="n">Zdot</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Xdot</span><span class="p">,</span><span class="n">Ydot</span><span class="p">,</span><span class="n">Zdot</span></div>

<div class="viewcode-block" id="calc_accel"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.calc_accel">[docs]</a><span class="k">def</span> <span class="nf">calc_accel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">E</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Compute 3-d acceleration of a single object on a Keplerian orbit given a </span>
<span class="sd">    set of orbital elements at a single observation point. </span>
<span class="sd">    Called by calc_OFTI</span>

<span class="sd">    Args:</span>
<span class="sd">        a (flt): semi-major axis, as</span>
<span class="sd">        T (flt): period, yrs</span>
<span class="sd">        to (flt): epoch of periastron passage (in same time structure as dates), yrs</span>
<span class="sd">        e (flt): eccentricity</span>
<span class="sd">        i (flt): inclination, rad</span>
<span class="sd">        w (flt): argument of periastron, rad</span>
<span class="sd">        O (flt): longitude of nodes, rad</span>
<span class="sd">        m1 (flt): system mass, Msun</span>
<span class="sd">        dist (flt): distance to system in pc, pc</span>
<span class="sd">        date (flt): observation date, yrs</span>
<span class="sd">        E (flt): eccentricity anomaly, computed in `calc_XYZ`</span>

<span class="sd">    Return: </span>
<span class="sd">        3-tuple:</span>
<span class="sd">            X ddot, Y ddot, Z ddot: 3d accelerations in m/s/yr</span>

<span class="sd">    Written by Logan Pearce, 2018</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1">#from lofti_gaiaDR2.loftifittingtools import to_si, solve</span>
    <span class="c1"># convert to km:</span>
    <span class="n">a_km</span> <span class="o">=</span> <span class="n">mas_to_km2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span>
    <span class="c1"># mean motion:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">T</span>
    <span class="c1"># r and f:</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span><span class="n">f2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_km</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="c1"># Time derivatives of r, f, and E:</span>
    <span class="n">Edot</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">))</span>
    <span class="n">rdot</span> <span class="o">=</span> <span class="n">e</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">n</span><span class="o">*</span><span class="n">a_km</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">fdot</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">))</span>
    <span class="c1"># Second time derivatives:</span>
    <span class="n">Eddot</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">n</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">fdot</span>
    <span class="n">rddot</span> <span class="o">=</span> <span class="n">a_km</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Edot</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">a_km</span><span class="o">*</span><span class="n">e</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">*</span><span class="n">Eddot</span>
    <span class="n">fddot</span> <span class="o">=</span> <span class="n">Eddot</span><span class="o">*</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">Edot</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">e</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)))</span>
    <span class="c1"># Positional accelerations:</span>
    <span class="n">Xddot</span> <span class="o">=</span> <span class="p">(</span><span class="n">rddot</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">fdot</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">+</span> \
            <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">rdot</span><span class="o">*</span><span class="n">fdot</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">fddot</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">Yddot</span> <span class="o">=</span> <span class="p">(</span><span class="n">rddot</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">fdot</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">+</span> \
            <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rdot</span><span class="o">*</span><span class="n">fdot</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">fddot</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">O</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">Zddot</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">rddot</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="n">fdot</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">rdot</span><span class="o">*</span><span class="n">fdot</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">fddot</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">+</span><span class="n">f</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">Xddot</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)),</span> <span class="n">Yddot</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)),</span> \
                    <span class="n">Zddot</span><span class="o">*</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">))</span></div>

<div class="viewcode-block" id="calc_OFTI"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.calc_OFTI">[docs]</a><span class="k">def</span> <span class="nf">calc_OFTI</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">rho</span><span class="p">,</span><span class="n">pa</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Perform OFTI steps to determine position/velocity/acceleration predictions given</span>
<span class="sd">    orbital elements.</span>

<span class="sd">    Args:</span>
<span class="sd">        Parameters (9 x N array):</span>
<span class="sd">        a (flt): semi-major axis, as</span>
<span class="sd">        T (flt): period, yrs</span>
<span class="sd">        to (flt): epoch of periastron passage (in same time structure as dates), yrs</span>
<span class="sd">        e (flt): eccentricity</span>
<span class="sd">        i (flt): inclination, rad</span>
<span class="sd">        w (flt): argument of periastron, rad</span>
<span class="sd">        O (flt): longitude of nodes, rad</span>
<span class="sd">        m1 (flt): system mass, Msun</span>
<span class="sd">        dist (flt): distance to system in pc, pc</span>
<span class="sd">        date (flt): observation date, yrs</span>
<span class="sd">        rho (tuple, flt): separation and error, mas</span>
<span class="sd">        pa (tuple, flt): position angle and error, deg</span>

<span class="sd">    Return: </span>
<span class="sd">        9-tuple:</span>
<span class="sd">            X, Y, Z:  positions in plane of the sky in mas</span>

<span class="sd">            X dot, Y dot, Z dot:  three dimensional velocities in km/s</span>

<span class="sd">            X ddot, Y ddot, Z ddot: 3d accelerations in m/s/yr</span>

<span class="sd">    Written by Logan Pearce, 2018</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
    <span class="c1">#a,T,const,to,e,i,w,O,m1,dist = parameters</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">parameters</span>
    <span class="c1"># pull values out of array:</span>
    <span class="n">a</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">dist</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="c1"># Calculate predicted positions at observation date:</span>
    <span class="n">X1</span><span class="p">,</span><span class="n">Y1</span><span class="p">,</span><span class="n">Z1</span><span class="p">,</span><span class="n">E1</span> <span class="o">=</span> <span class="n">calc_XYZ</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">to</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
    <span class="c1"># scale and rotate:</span>
    <span class="n">a2</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span><span class="n">to2</span><span class="p">,</span><span class="n">O2</span> <span class="o">=</span> <span class="n">scale_and_rotate</span><span class="p">(</span><span class="n">X1</span><span class="p">,</span><span class="n">Y1</span><span class="p">,</span><span class="n">rho</span><span class="p">,</span><span class="n">pa</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
    <span class="c1"># recompute predicted position:</span>
    <span class="n">X2</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="n">Z2</span><span class="p">,</span><span class="n">E2</span> <span class="o">=</span> <span class="n">calc_XYZ</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span><span class="n">to2</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O2</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
    <span class="c1"># convert units:</span>
    <span class="n">X2</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="n">Z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">X2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Y2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Z2</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="c1"># Compute velocities at observation date:</span>
    <span class="n">Xdot</span><span class="p">,</span><span class="n">Ydot</span><span class="p">,</span><span class="n">Zdot</span> <span class="o">=</span> <span class="n">calc_velocities</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span><span class="n">to2</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O2</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">E2</span><span class="p">)</span>
    <span class="c1"># Compute accelerations at observation date:</span>
    <span class="n">Xddot</span><span class="p">,</span><span class="n">Yddot</span><span class="p">,</span><span class="n">Zddot</span> <span class="o">=</span> <span class="n">calc_accel</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span><span class="n">to2</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O2</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">dist</span><span class="p">,</span><span class="n">E2</span><span class="p">)</span>
    <span class="c1"># Convert to degrees for output:</span>
    <span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">w</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">O2</span><span class="p">)</span>
    <span class="c1"># put back into output array:</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2</span><span class="p">,</span><span class="n">T2</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">to2</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">O2</span>
    <span class="c1">#return X2,Y2,Z2,Xdot,Ydot,Zdot,Xddot,Yddot,Zddot,a2,T2,to2,e,i,w,O2</span>
    <span class="k">return</span> <span class="n">X2</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="n">Z2</span><span class="p">,</span><span class="n">Xdot</span><span class="p">,</span><span class="n">Ydot</span><span class="p">,</span><span class="n">Zdot</span><span class="p">,</span><span class="n">Xddot</span><span class="p">,</span><span class="n">Yddot</span><span class="p">,</span><span class="n">Zddot</span><span class="p">,</span><span class="n">p</span></div>

<div class="viewcode-block" id="AcceptOrReject"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.AcceptOrReject">[docs]</a><span class="k">def</span> <span class="nf">AcceptOrReject</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">chi_min</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Perform rejection sampling accept/reject decision</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        chi2 (1xN array): array of chi2 values</span>
<span class="sd">        chi_min (flt): min chi2 value</span>

<span class="sd">    Returns:</span>
<span class="sd">        3-tuple:</span>
<span class="sd">            accepted: Array of indicies of accepted</span>

<span class="sd">            lnprob: log probability of accepted orbits</span>
<span class="sd">            </span>
<span class="sd">            lnrand: log of the random &quot;dice roll&quot; for acceptance</span>

<span class="sd">    Written by Logan Pearce, 2020</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nvals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chi2</span><span class="p">)</span>
    <span class="n">lnprob</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">chi2</span><span class="o">-</span><span class="n">chi_min</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">nvals</span><span class="p">)</span>
    <span class="n">accepted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lnprob</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rand</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">accepted</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rand</span><span class="p">)</span></div>

<div class="viewcode-block" id="update_progress"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.update_progress">[docs]</a><span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">max_value</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Create a progress bar</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        n (int): current count</span>
<span class="sd">        max_value (int): ultimate values</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">barLength</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># Modify this to change the length of the progress bar</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">max_value</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;error: progress var must be float</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Halt...</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">progress</span> <span class="o">&gt;=</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Done...</span><span class="se">\r\n</span><span class="s2">&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">barLength</span><span class="o">*</span><span class="n">progress</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="si">{0}</span><span class="s2">% (</span><span class="si">{1}</span><span class="s2"> of </span><span class="si">{2}</span><span class="s2">): |</span><span class="si">{3}</span><span class="s2">|  </span><span class="si">{4}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">progress</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
                                                  <span class="n">n</span><span class="p">,</span> 
                                                  <span class="n">max_value</span><span class="p">,</span> 
                                                  <span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="n">block</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="p">(</span><span class="n">barLength</span><span class="o">-</span><span class="n">block</span><span class="p">),</span> 
                                                  <span class="n">status</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<span class="c1">###  Stats functions  ###</span>
<div class="viewcode-block" id="freedman_diaconis"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.freedman_diaconis">[docs]</a><span class="k">def</span> <span class="nf">freedman_diaconis</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Compute the optimal number of bins for a 1-d histogram using the Freedman-Diaconis rule of thumb</span>
<span class="sd">    Bin width = 2IQR/cuberoot(N)</span>

<span class="sd">    Args:</span>
<span class="sd">        array (arr): flattened array of data</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            bin_width (flt): width of bin in optimal binning</span>

<span class="sd">            n (int): number of bins</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="c1"># Get number of observations:</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">array</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Get interquartile range:</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">25</span><span class="p">,</span> <span class="o">.</span><span class="mi">75</span><span class="p">]))</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">iqr</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">N</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">array</span><span class="p">))</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bin_width</span><span class="p">,</span> <span class="n">n</span></div>

<div class="viewcode-block" id="Mode"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.Mode">[docs]</a><span class="k">def</span> <span class="nf">Mode</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute mode of an array</span>

<span class="sd">    Args:</span>
<span class="sd">        array (arr, flt): array to compute the mode</span>
<span class="sd">    Returns:</span>
<span class="sd">        flt: mode</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># create histogram:</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">freedman_diaconis</span><span class="p">(</span><span class="n">array</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># max bin</span>
    <span class="n">max_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="c1"># find inner/outer bin edges</span>
    <span class="n">bin_inner_edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="n">max_bin</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bin_outer_edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">n</span><span class="o">==</span><span class="n">max_bin</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
    <span class="c1"># value in the middle of the highest bin:</span>
    <span class="n">mode</span><span class="o">=</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">bin_outer_edge</span><span class="p">]</span> <span class="o">-</span> <span class="n">bins</span><span class="p">[</span><span class="n">bin_inner_edge</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">bins</span><span class="p">[</span><span class="n">bin_inner_edge</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="calc_min_credible_interval"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.calc_min_credible_interval">[docs]</a><span class="k">def</span> <span class="nf">calc_min_credible_interval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Internal method to determine the minimum interval of a given width</span>
<span class="sd">    Assumes that x is sorted numpy array.</span>
<span class="sd">    From: https://github.com/aloctavodia/Doing_bayesian_data_analysis/blob/master/hpd.py</span>

<span class="sd">    Args: </span>
<span class="sd">        x (arr, flt): array of values for which to compute Min Cred Int</span>
<span class="sd">        alpha (flt): statistical alpha value; 1-alpha is the interval. Ex: alpha = 0.05 -&gt; 95% min cred int.</span>
<span class="sd">    Returns: </span>
<span class="sd">        tuple:</span>
<span class="sd">            hdi_min, hdi_max (flt): min and max values of interval encompassing (1-alpha)% of of the data</span>

<span class="sd">    Written by Logan Pearce, 2019</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">cred_mass</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">alpha</span>

    <span class="n">interval_idx_inc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">cred_mass</span><span class="o">*</span><span class="n">n</span><span class="p">))</span>
    <span class="n">n_intervals</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">interval_idx_inc</span>
    <span class="n">interval_width</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">interval_idx_inc</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="n">n_intervals</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_width</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Too few elements for interval calculation&#39;</span><span class="p">)</span>

    <span class="n">min_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">interval_width</span><span class="p">)</span>
    <span class="n">hdi_min</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">min_idx</span><span class="p">]</span>
    <span class="n">hdi_max</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">min_idx</span><span class="o">+</span><span class="n">interval_idx_inc</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">hdi_min</span><span class="p">,</span> <span class="n">hdi_max</span></div>

<div class="viewcode-block" id="compute_statistics"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.compute_statistics">[docs]</a><span class="k">def</span> <span class="nf">compute_statistics</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute summary statistics of an array</span>

<span class="sd">    Args:</span>
<span class="sd">        array (arr, flt): array to compute the mode</span>
<span class="sd">    Returns:</span>
<span class="sd">        array:</span>
<span class="sd">            mean (flt): mean of array from np.mean</span>

<span class="sd">            median (flt): median of array from np.median</span>

<span class="sd">            mode (flt): mode of array</span>

<span class="sd">            std (flt): standard deviation from np.std</span>

<span class="sd">            ci68 (tuple, flt): 68% minimum credible interval</span>

<span class="sd">            ci95 (tuple, flt): 95% minimum credible interval</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">Mode</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="c1"># 68% CI:</span>
    <span class="n">sorts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">frac</span><span class="o">=</span><span class="mf">0.683</span>
    <span class="n">ci68</span> <span class="o">=</span> <span class="n">calc_min_credible_interval</span><span class="p">(</span><span class="n">sorts</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac</span><span class="p">))</span>
    <span class="c1"># 95% CI:</span>
    <span class="n">frac</span><span class="o">=</span><span class="mf">0.954</span>
    <span class="n">ci95</span> <span class="o">=</span> <span class="n">calc_min_credible_interval</span><span class="p">(</span><span class="n">sorts</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="n">frac</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">ci68</span><span class="p">,</span> <span class="n">ci95</span></div>

<div class="viewcode-block" id="limit_to_180deg"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.limit_to_180deg">[docs]</a><span class="k">def</span> <span class="nf">limit_to_180deg</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Limit elements of array to [0,180] degrees</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">array</span> <span class="o">%</span> <span class="mi">180</span></div>

<div class="viewcode-block" id="orbits_for_plotting"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.orbits_for_plotting">[docs]</a><span class="k">def</span> <span class="nf">orbits_for_plotting</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">T1</span><span class="p">,</span><span class="n">to1</span><span class="p">,</span><span class="n">e1</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">O1</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Compute inputs specifically for plotting functions</span>

<span class="sd">    Args:</span>
<span class="sd">        a [as]: semi-major axis</span>
<span class="sd">        T [yrs]: period</span>
<span class="sd">        to [yrs]: epoch of periastron passage (in same time structure as dates)</span>
<span class="sd">        e: eccentricity</span>
<span class="sd">        i [rad]: inclination</span>
<span class="sd">        w [rad]: argument of periastron</span>
<span class="sd">        O [rad]: longitude of nodes</span>
<span class="sd">        t (flt): time at which to compute the position</span>
<span class="sd">    Returns: </span>
<span class="sd">        tuple:</span>
<span class="sd">            X, Y (flt): positions in plane of the sky [mas]</span>

<span class="sd">    Written by Logan Pearce, 2020</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="n">T1</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">to1</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">M1</span> <span class="ow">in</span> <span class="n">M</span><span class="p">:</span>
        <span class="n">nextE</span> <span class="o">=</span> <span class="n">danby_solve</span><span class="p">(</span><span class="n">eccentricity_anomaly</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>  
        <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">nextE</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">a1</span><span class="o">*</span><span class="p">((</span><span class="n">cos</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w1</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i1</span><span class="p">)))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">a1</span><span class="o">*</span><span class="p">((</span><span class="n">sin</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w1</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i1</span><span class="p">)))</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">a1</span><span class="o">*</span><span class="p">((</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w1</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i1</span><span class="p">)))</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">a1</span><span class="o">*</span><span class="p">((</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">w1</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">O1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">i1</span><span class="p">)))</span>
    <span class="n">xe</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="o">-</span><span class="n">e1</span>
    <span class="n">ye</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">e1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="n">X1</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">xe</span> <span class="o">+</span> <span class="n">F</span><span class="o">*</span><span class="n">ye</span>
    <span class="n">Y1</span> <span class="o">=</span> <span class="n">B</span><span class="o">*</span><span class="n">xe</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">ye</span>
    <span class="k">return</span> <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span></div>

<div class="viewcode-block" id="make_parameter_string"><a class="viewcode-back" href="../../loftitools.html#lofti_gaiaDR2.loftitools.make_parameter_string">[docs]</a><span class="k">def</span> <span class="nf">make_parameter_string</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Make a string of stats for writing to txt file.</span>

<span class="sd">    Args:</span>
<span class="sd">        thing (arr, flt): Stats parameter object. Ex: results.stats.sma</span>
<span class="sd">        name (str): name of parameter</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="s1">&#39;   &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="n">thing</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span><span class="n">thing</span><span class="o">.</span><span class="n">median</span><span class="p">,</span>\
                <span class="n">thing</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span><span class="n">thing</span><span class="o">.</span><span class="n">std</span><span class="p">,</span><span class="n">thing</span><span class="o">.</span><span class="n">ci68</span><span class="p">,</span><span class="n">thing</span><span class="o">.</span><span class="n">ci95</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">string</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Logan Pearce

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>